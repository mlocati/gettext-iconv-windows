name: Build

on:
  pull_request:
    paths:
      - .github/workflows/build.yml
      - build-exe/**
  push:
    branches:
      - main
    tags-ignore:
      - "**"
    paths:
      - .github/workflows/build.yml
      - build-exe/**
  workflow_dispatch:
    inputs:
      sign:
        description: Sign binaries
        type: choice
        options:
          - 'no'
          - test
          - production
        default: test
      cldr-version:
        description: CLDR Version
        type: string
        required: false
      iconv-version:
        description: Iconv Version
        type: string
        required: false
      curl-version:
        description: Curl Version
        type: string
        required: false
      json-c-version:
        description: JSON-C Version
        type: string
        required: false
      gettext-version:
        description: Gettext Version
        type: string
        required: false

jobs:

  test-bash-scripts:
    name: Test bash scripts
    runs-on: ubuntu-latest
    container:
      image: mvdan/shfmt:v3.12.0-alpine
      options: --entrypoint /bin/sh
    steps:
      -
        name: Checkout
        uses: actions/checkout@v6
      -
        name: Check scripts
        run: |
          files="$(shfmt --find .)"
          if [ $? -ne 0 ] || [ -z "$files" ]; then
            echo 'Failed to list shell scripts'
            exit 1
          fi
          rc=0
          for file in $files; do
            printf '# %s... ' "$file"
            if shfmt --diff --simplify --indent 4 --case-indent --func-next-line -- "$file"; then
              echo 'ok.'
            else
              rc=1
              printf '\n\n'
            fi
          done
          exit $rc

  test-pwsh-scripts:
    name: Test PowerShell scripts
    runs-on: windows-latest
    steps:
      -
        name: Install PSScriptAnalyzer
        run: Install-Module -Name PSScriptAnalyzer -RequiredVersion 1.24.0 -Force -SkipPublisherCheck -Verbose
      -
        name: Checkout
        uses: actions/checkout@v6
      -
        name: Check scripts
        run: |
          $rc = 0
          $files = Get-ChildItem -Path . -Recurse -File -Filter *.ps1
          foreach ($file in $files) {
            Write-Host -Object "# $($file.Name)... " -NoNewline
            $records = Invoke-ScriptAnalyzer -Path $file -ExcludeRule PSAvoidUsingWriteHost,PSUseShouldProcessForStateChangingFunctions,PSUseSingularNouns
            if (-not($records)) {
              Write-Host -Object 'ok.'
            } else {
              $rc = 1
              Write-Host -Object 'ERRORS!'
              foreach ($record in $records) {
                Write-Host -Object "  - line $($record.Line): $($record.RuleName))`n    $($record.Message)`n"
              }
              Write-Host -Object ''
            }
          }
          exit $rc

  versions:
    name: Resolve versions
    #needs:
      #- test-bash-scripts
      #- test-pwsh-scripts
    outputs:
      cygwin-mirror: ${{ steps.resolve.outputs.cygwin-mirror }}
      cldr-version: ${{ steps.resolve.outputs.cldr-version }}
      iconv-version: ${{ steps.resolve.outputs.iconv-version }}
      iconv-tarball-from-commit: ${{ steps.resolve.outputs.iconv-tarball-from-commit }}
      iconv-source-url: ${{ steps.resolve.outputs.iconv-source-url }}
      curl-version: ${{ steps.resolve.outputs.curl-version }}
      json-c-version: ${{ steps.resolve.outputs.json-c-version }}
      gettext-version: ${{ steps.resolve.outputs.gettext-version }}
      gettext-source-url: ${{ steps.resolve.outputs.gettext-source-url }}
      signpath-signing-policy: ${{ steps.resolve.outputs.signpath-signing-policy }}
      signpath-artifactconfiguration-files: ${{ steps.resolve.outputs.signpath-artifactconfiguration-files }}
      signatures-canbeinvalid: ${{ steps.resolve.outputs.signatures-canbeinvalid }}
    runs-on: windows-2022
    steps:
      -
        name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: ${{ github.event_name == 'pull_request' && '0' || '1' }}
      -
        name: Resolve
        id: resolve
        shell: pwsh
        run: >
          ./build-exe/resolve-versions.ps1
          -CLDRVersion '${{ github.event.inputs.cldr-version }}'
          -IconvVersion '${{ github.event.inputs.iconv-version }}'
          -CurlVersion '${{ github.event.inputs.curl-version }}'
          -JsonCVersion '${{ github.event.inputs.json-c-version }}'
          -GettextVersion '${{ github.event.inputs.gettext-version }}'
          -Sign '${{ github.event.inputs.sign }}'

  build-iconv-tarball:
    name: Build iconv tarball
    needs:
      - versions
    outputs:
      artifact-id: ${{ steps.upload.outputs.artifact-id }}
    runs-on: ubuntu-latest
    container:
      image: debian:trixie
    steps:
      -
        name: Update system
        if: needs.versions.outputs.iconv-tarball-from-commit
        run: |
          apt-get update -q
          apt-get upgrade -qy
      -
        name: Install system dependencies
        if: needs.versions.outputs.iconv-tarball-from-commit
        run: >
          apt-get install -qy --no-install-recommends
          ca-certificates git gcc libc6-dev autoconf automake m4 gperf groff perl make python3 patch autotools-dev curl gettext xz-utils
      -
        name: Install automake 1.18
        if: needs.versions.outputs.iconv-tarball-from-commit
        working-directory: /tmp
        run: |
          curl -sSL https://ftp.gnu.org/gnu/automake/automake-1.18.tar.xz | tar -xJ
          cd automake-*
          ./configure
          make install
      -
        name: Configure git
        run: git config --global --add safe.directory "$(pwd)"
      -
        name: Download iconv source code
        if: needs.versions.outputs.iconv-tarball-from-commit
        run: git clone https://git.savannah.gnu.org/git/libiconv.git .
      -
        name: Checkout commit ${{ needs.versions.outputs.iconv-tarball-from-commit }}
        if: needs.versions.outputs.iconv-tarball-from-commit
        run: git checkout ${{ needs.versions.outputs.iconv-tarball-from-commit }}
      -
        name: Pull git dependencies
        if: needs.versions.outputs.iconv-tarball-from-commit
        run: ./autopull.sh
      -
        name: Autogenerate build system
        if: needs.versions.outputs.iconv-tarball-from-commit
        run: ./autogen.sh
      -
        name: Configure
        if: needs.versions.outputs.iconv-tarball-from-commit
        run: ./configure
      -
        name: Build tarball
        if: needs.versions.outputs.iconv-tarball-from-commit
        run: make dist
      -
        name: Upload tarball
        if: needs.versions.outputs.iconv-tarball-from-commit
        id: upload
        uses: actions/upload-artifact@v6
        with:
          name: iconv-tarball
          path: libiconv-${{ needs.versions.outputs.iconv-version }}.tar.gz
          if-no-files-found: error

  exe:
    name: ${{ matrix.bits}}-bit ${{ matrix.link }} executables
    needs:
      - versions
      - build-iconv-tarball
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        bits:
          - 32
          - 64
        link:
          - shared
          - static
    env:
      CYGWIN_NOWINPATH: 1
      CHERE_INVOKING: 1
    defaults:
      run:
        shell: C:\cygwin\bin\bash.exe --login -o igncr -o errexit -o pipefail {0}
    steps:
      -
        name: Configure git
        shell: cmd
        run: git config --global core.autocrlf input
      -
        name: Checkout
        uses: actions/checkout@v6
      -
        name: Restore cache
        id: restore-cache
        uses: actions/cache/restore@v5
        with:
          key: build-exe-${{ matrix.link }}-${{ matrix.bits }}
          path: |
            C:\cygwin-packages
      -
        name: Set case-specific variables
        id: vars
        shell: pwsh
        run: >
          ./build-exe/case-vars.ps1
          -Bits ${{ matrix.bits }}
          -Link ${{ matrix.link }}
          -InstalledPath installed
          -CLDRVersion ${{ needs.versions.outputs.cldr-version }}
          -IconvVersion ${{ needs.versions.outputs.iconv-version }}
          -CurlVersion ${{ needs.versions.outputs.curl-version }}
          -JsonCVersion ${{ needs.versions.outputs.json-c-version }}
          -GettextVersion ${{ needs.versions.outputs.gettext-version }}
      -
        name: Install Cygwin
        uses: cygwin/cygwin-install-action@v6
        timeout-minutes: 60
        with:
          packages: ${{ steps.vars.outputs.cygwin-packages }}
          install-dir: C:\cygwin
          site: ${{ needs.versions.outputs.cygwin-mirror }}
          add-to-path: false
      -
        name: Setup Cygwin environment
        run: |
          PATH='${{ steps.vars.outputs.cygwin-path }}'
          cd -- "$(cygpath -ua '${{ github.workspace }}')"
          mkdir -p src/downloads
          mkdir -p installed/bin
          mkdir -p installed/include
          mkdir -p installed/lib
          mkdir -p installed/licenses
          mkdir files-unsigned
          mkdir files-signed
          mkdir installer-unsigned
          mkdir installer-signed
          cp ./LICENSE.txt installed/license.txt
          mkdir -p "$HOME"
          printf "\nPATH='${{ steps.vars.outputs.cygwin-path }}'\nexport PATH\n" >>$HOME/.bash_profile
      -
        name: Dump Cygwin environment
        run: |
          printf 'Current working directory: %s\n' "$(pwd)"
          echo 'PATH contains:'
          IFS=:
          for p in $PATH; do
            printf -- '- %s\n' "$p"
          done
      -
        name: Download CLDR
        working-directory: src\downloads
        shell: pwsh
        run: |
          if (Test-Path -LiteralPath cldr-${{ needs.versions.outputs.cldr-version }}.zip -PathType Leaf) {
            Write-Host -Object 'Already downloaded'
          } else {
            Invoke-WebRequest -Uri https://unicode.org/Public/cldr/${{ needs.versions.outputs.cldr-version }}/core.zip -OutFile cldr-${{ needs.versions.outputs.cldr-version }}.zip
            Write-Host -Object 'Downloaded'
          }
      -
        name: Download iconv artifact
        if: needs.versions.outputs.iconv-tarball-from-commit
        uses: actions/download-artifact@v7
        with:
          artifact-ids: ${{ needs.build-iconv-tarball.outputs.artifact-id }}
          path: src/downloads/
      -
        name: TEST
        run: ls -R src/downloads
      -
        name: Download iconv
        if: ${{ !needs.versions.outputs.iconv-tarball-from-commit }}
        working-directory: src\downloads
        shell: pwsh
        run: |
          if (Test-Path -LiteralPath libiconv-${{ needs.versions.outputs.iconv-version }}.tar.gz -PathType Leaf) {
            Write-Host -Object 'Already downloaded'
          } else {
            Invoke-WebRequest -Uri ${{ needs.versions.outputs.iconv-source-url }} -OutFile libiconv-${{ needs.versions.outputs.iconv-version }}.tar.gz
            Write-Host -Object 'Downloaded'
          }
      -
        name: Download curl
        if: needs.versions.outputs.curl-version
        working-directory: src\downloads
        shell: pwsh
        run: |
          if (Test-Path -LiteralPath curl-${{ needs.versions.outputs.curl-version }}.tar.gz -PathType Leaf) {
            Write-Host -Object 'Already downloaded'
          } else {
            Invoke-WebRequest -Uri https://curl.se/download/curl-${{ needs.versions.outputs.curl-version }}.tar.gz -OutFile curl-${{ needs.versions.outputs.curl-version }}.tar.gz
            Write-Host -Object 'Downloaded'
          }
      -
        name: Download JSON-C
        if: needs.versions.outputs.json-c-version
        working-directory: src\downloads
        shell: pwsh
        run: |
          if (Test-Path -LiteralPath json-c-${{ needs.versions.outputs.json-c-version }}.tar.gz -PathType Leaf) {
            Write-Host -Object 'Already downloaded'
          } else {
            Invoke-WebRequest -Uri https://s3.amazonaws.com/json-c_releases/releases/json-c-${{ needs.versions.outputs.json-c-version }}-nodoc.tar.gz -OutFile json-c-${{ needs.versions.outputs.json-c-version }}.tar.gz
            Write-Host -Object 'Downloaded'
          }
      -
        name: Download gettext
        working-directory: src\downloads
        shell: pwsh
        run: |
          if (Test-Path -LiteralPath gettext-${{ needs.versions.outputs.gettext-version }}.tar.gz -PathType Leaf) {
            Write-Host -Object 'Already downloaded'
          } else {
            Invoke-WebRequest -Uri ${{ needs.versions.outputs.gettext-source-url }} -OutFile gettext-${{ needs.versions.outputs.gettext-version }}.tar.gz
            Write-Host -Object 'Downloaded'
          }
      -
        name: Add GCC Runtime license
        run: |
          cp /usr/share/doc/mingw64-${{ steps.vars.outputs.mingw-architecture }}-gcc/COPYING installed/licenses/gcc.txt
      -
        name: Extract CLDR
        run: |
          unzip -p src/downloads/cldr-${{ needs.versions.outputs.cldr-version }}.zip LICENSE > installed/licenses/cldr.txt
          mkdir -p installed/share/gettext/cldr/common/supplemental
          unzip -p src/downloads/cldr-${{ needs.versions.outputs.cldr-version }}.zip common/supplemental/plurals.xml >installed/share/gettext/cldr/common/supplemental/plurals.xml
      -
        name: Simplify CLDR plurals.xml
        if: steps.vars.outputs.cldr-simplify-plurals-xml == 'yes'
        shell: pwsh
        run: ./build-exe/simplify-plurals-xml.ps1 installed/share/gettext/cldr/common/supplemental/plurals.xml
      -
        name: Extract iconv
        run: |
          tar x -C src -z -f src/downloads/libiconv-${{ needs.versions.outputs.iconv-version }}.tar.gz
          cp src/libiconv-${{ needs.versions.outputs.iconv-version }}/COPYING installed/licenses/iconv.txt
      -
        name: Extract curl
        if: needs.versions.outputs.curl-version
        run: |
          tar x -C src -z -f src/downloads/curl-${{ needs.versions.outputs.curl-version }}.tar.gz
          cp src/curl-${{ needs.versions.outputs.curl-version }}/COPYING installed/licenses/curl.txt
      -
        name: Extract JSON-C
        if: needs.versions.outputs.json-c-version
        run: |
          tar x -C src -z -f src/downloads/json-c-${{ needs.versions.outputs.json-c-version }}.tar.gz
          cp src/json-c-${{ needs.versions.outputs.json-c-version }}/COPYING installed/licenses/json-c.txt
      -
        name: Extract gettext
        run: |
          tar x -C src -z -f src/downloads/gettext-${{ needs.versions.outputs.gettext-version }}.tar.gz
          cp src/gettext-${{ needs.versions.outputs.gettext-version }}/COPYING installed/licenses/gettext.txt
      -
        name: Apply patches
        run: |
          set -o errexit
          for dir in $(find src/* -maxdepth 1 -type d -printf '%f\n'); do
            if ! test -d "patches/$dir"; then
              continue
            fi
            printf 'Applying patches for %s\n' "$dir"
            for patchfile in $(find patches/$dir -maxdepth 1 -type f -printf '%f\n' | sort); do
              printf -- '- %s\n' "$patchfile"
              patch -d "src/$dir" -p1 -u <"patches/$dir/$patchfile"
            done
          done
      -
        name: Configure iconv (1st time)
        id: iconv-configure
        working-directory: src\libiconv-${{ needs.versions.outputs.iconv-version }}
        run: |
          mkdir build
          cd build
          ../configure ${{ steps.vars.outputs.iconv-configure-args }}
      -
        name: Compile iconv (1st time)
        working-directory: src\libiconv-${{ needs.versions.outputs.iconv-version }}\build
        run: make --jobs=$(nproc)
      -
        name: Check iconv (1st time)
        working-directory: src\libiconv-${{ needs.versions.outputs.iconv-version }}\build
        run: make --jobs=$(nproc) check
      -
        name: Install iconv (1st time)
        working-directory: src\libiconv-${{ needs.versions.outputs.iconv-version }}\build
        run: make --jobs=$(nproc) install-strip
      -
        name: Configure curl
        if: needs.versions.outputs.curl-version
        id: curl-configure
        working-directory: src\curl-${{ needs.versions.outputs.curl-version }}
        run: |
          mkdir build
          cd build
          ../configure ${{ steps.vars.outputs.curl-configure-args }}
          if [ "$(./curl-config --built-shared)" = yes ]; then
            libs="$(./curl-config --libs)"
          else
            libs="$(./curl-config --static-libs)"
          fi
          echo "libs=$libs" >>"$GITHUB_OUTPUT"
          echo 'OUTPUTS:'
          cat "$GITHUB_OUTPUT"
      -
        name: Install curl - libcurl
        if: needs.versions.outputs.curl-version
        working-directory: src\curl-${{ needs.versions.outputs.curl-version }}\build\lib
        run: make --jobs=$(nproc) install-strip
      -
        name: Install curl - include
        if: needs.versions.outputs.curl-version
        working-directory: src\curl-${{ needs.versions.outputs.curl-version }}\build\include
        run: make --jobs=$(nproc) install-strip
      -
        name: Prepare JSON-C
        if: needs.versions.outputs.json-c-version
        working-directory: src\json-c-${{ needs.versions.outputs.json-c-version }}
        run: |
          mkdir build
          cd build
          cmake ${{ steps.vars.outputs.json-c-cmake-args }} ../
      -
        name: Build JSON-C
        if: needs.versions.outputs.json-c-version
        working-directory: src\json-c-${{ needs.versions.outputs.json-c-version }}\build
        run: make --jobs=$(nproc) all
      -
        name: Install JSON-C
        if: needs.versions.outputs.json-c-version
        working-directory: src\json-c-${{ needs.versions.outputs.json-c-version }}\build
        run: make install/strip
      -
        name: Configure gettext
        id: gettext-configure
        working-directory: src\gettext-${{ needs.versions.outputs.gettext-version }}
        run: |
          mkdir build
          cd build
          ../configure ${{ steps.vars.outputs.gettext-configure-args }} LIBS='${{ steps.curl-configure.outputs.libs }}'
      -
        name: Ignore gettext C tests
        if: steps.vars.outputs.gettext-ignore-c-tests
        working-directory: src\gettext-${{ needs.versions.outputs.gettext-version }}
        run: for f in ${{ steps.vars.outputs.gettext-ignore-c-tests }}; do echo 'int main() { return 0; }' >$f; done
      -
        name: Compile gettext/gnulib-local
        working-directory: src\gettext-${{ needs.versions.outputs.gettext-version }}\build\gnulib-local
        run: make --jobs=$(nproc)
      -
        name: Check gettext/gnulib-local
        working-directory: src\gettext-${{ needs.versions.outputs.gettext-version }}\build\gnulib-local
        run: make --jobs=$(nproc) check
      -
        name: Install gettext/gnulib-local
        working-directory: src\gettext-${{ needs.versions.outputs.gettext-version }}\build\gnulib-local
        run: make --jobs=$(nproc) install-strip
      -
        name: Compile gettext/gettext-runtime
        working-directory: src\gettext-${{ needs.versions.outputs.gettext-version }}\build\gettext-runtime
        run: make --jobs=$(nproc)
      -
        name: Check gettext/gettext-runtime
        working-directory: src\gettext-${{ needs.versions.outputs.gettext-version }}\build\gettext-runtime
        run: make --jobs=$(nproc) check
      -
        name: Install gettext/gettext-runtime
        working-directory: src\gettext-${{ needs.versions.outputs.gettext-version }}\build\gettext-runtime
        run: make --jobs=$(nproc) install-strip
      -
        name: Compile gettext/libtextstyle
        working-directory: src\gettext-${{ needs.versions.outputs.gettext-version }}\build\libtextstyle
        run: make --jobs=$(nproc)
      -
        name: Check gettext/libtextstyle
        working-directory: src\gettext-${{ needs.versions.outputs.gettext-version }}\build\libtextstyle
        run: make --jobs=$(nproc) check
      -
        name: Install gettext/libtextstyle
        working-directory: src\gettext-${{ needs.versions.outputs.gettext-version }}\build\libtextstyle
        run: make --jobs=$(nproc) install-strip
      -
        name: Compile gettext/gettext-tools
        working-directory: src\gettext-${{ needs.versions.outputs.gettext-version }}\build\gettext-tools
        run: make --jobs=$(nproc)
      -
        name: Check gettext/gettext-tools
        working-directory: src\gettext-${{ needs.versions.outputs.gettext-version }}\build\gettext-tools
        run: XFAIL_TESTS='${{ steps.vars.outputs.gettext-xfail-gettext-tools }}' make --jobs=$(nproc) check
      -
        name: Install gettext/gettext-tools
        working-directory: src\gettext-${{ needs.versions.outputs.gettext-version }}\build\gettext-tools
        run: make --jobs=$(nproc) install-strip
      -
        # We need to rebuild iconv because it depends on gettext's libintl in order to be localizable
        name: Configure iconv (2nd time)
        working-directory: src\libiconv-${{ needs.versions.outputs.iconv-version }}
        run: |
          rm -rf build
          mkdir build
          cd build
          ../configure ${{ steps.vars.outputs.iconv-configure-args }} \
            --enable-extra-encodings
      -
        name: Compile iconv (2nd time)
        working-directory: src\libiconv-${{ needs.versions.outputs.iconv-version }}\build
        run: make --jobs=$(nproc)
      -
        name: Check iconv (2nd time)
        working-directory: src\libiconv-${{ needs.versions.outputs.iconv-version }}\build
        run: make --jobs=$(nproc) check
      -
        name: Install iconv (2nd time)
        working-directory: src\libiconv-${{ needs.versions.outputs.iconv-version }}\build
        run: make --jobs=$(nproc) install-strip
      -
        name: Prepare build log
        id: prepare-build-log
        if: (success() || failure()) && steps.iconv-configure.outcome == 'success'
        run: |
          mkdir build-log
          if [ -d src/libiconv-${{ needs.versions.outputs.iconv-version }}/build ]; then
            tar c -J -f build-log/iconv.tar.xz src/libiconv-${{ needs.versions.outputs.iconv-version }}/build
          fi
          if [ -d src/curl-${{ needs.versions.outputs.curl-version }}/build ]; then
            tar c -J -f build-log/curl.tar.xz src/curl-${{ needs.versions.outputs.curl-version }}/build
          fi
          if [ -d src/json-c-${{ needs.versions.outputs.json-c-version }}/build ]; then
            tar c -J -f build-log/json-c.tar.xz src/json-c-${{ needs.versions.outputs.json-c-version }}/build
          fi
          if [ -d src/gettext-${{ needs.versions.outputs.gettext-version }}/build ]; then
            tar c -J -f build-log/gettext.tar.xz src/gettext-${{ needs.versions.outputs.gettext-version }}/build
          fi
          if find installed -mindepth 1 -maxdepth 1 | read; then
            tar c -J -f build-log/installed.tar.xz installed
          fi
          ls -al build-log
      -
        name: Copy built assets
        run: ./build-exe/create-output.sh installed files-unsigned
      -
        name: Delete install directory
        run: rm -rf installed
      -
        name: Process dependencies
        shell: pwsh
        run: >
          ./build-exe/process-dependencies.ps1
          -Bits ${{ matrix.bits }}
          -Link ${{ matrix.link }}
          -Path files-unsigned
          -MinGWPath C:\cygwin\usr\${{ steps.vars.outputs.mingw-host }}
      -
        name: Extract version infos
        id: versioninfos
        shell: pwsh
        run: ./build-exe/extract-versiononfos.ps1 -RootPath '.\files-unsigned'
      -
        name: Check bitness
        run: ./build-exe/check-bits.sh ${{ matrix.bits }} files-unsigned
      -
        name: Check if iconv program load translations correctly
        shell: pwsh
        run: |
          $env:LANGUAGE = 'it'
          $stdout = & .\files-unsigned\bin\iconv.exe --help
          if (-not($?)) {
            throw "iconv.exe failed"
          }
          $stdout = $stdout -join "`n"
          if (!$stdout.Contains('formato di input')) {
            throw "iconv.exe didn't load the translations.`nIts output is:`n$stdout"
          }
          Write-Host "iconv.exe correctly loaded the translations when LANGUAGE=$env:LANGUAGE`nIts localized output is`n$stdout"
      -
        name: Check if gettext programs load translations correctly
        shell: pwsh
        run: |
          $env:LANGUAGE = 'it'
          $stdout = & .\files-unsigned\bin\xgettext.exe --help
          if (-not($?)) {
            throw "xgettext.exe failed"
          }
          $stdout = $stdout -join "`n"
          if (!$stdout.Contains('impostazione predefinita')) {
            throw "xgettext.exe didn't load the translations.`nIts output is:`n$stdout"
          }
          Write-Host "xgettext.exe correctly loaded the translations when LANGUAGE=$env:LANGUAGE`nIts localized output is`n$stdout"
      -
        name: Check cldr-plurals
        shell: pwsh
        run: |
          $pot = @'
          msgid ""
          msgstr ""
          "Content-Type: text/plain; charset=UTF-8\n"
          "MIME-Version: 1.0\n"
          "Content-Transfer-Encoding: 8bit\n"

          msgid "Hi"
          msgstr ""
          '@
          $lang = 'zu'

          Remove-Item -LiteralPath Env:GETTEXTCLDRDIR -ErrorAction SilentlyContinue
          $po = $pot | & .\files-unsigned\bin\msginit.exe --input=- --output-file=- --locale="$lang"
          $rule = $po -match "Plural-Forms:"
          if ($rule) {
            throw "Without GETTEXTCLDRDIR there shouldn't be a Plural-Forms header in the .po file for the locale $lang, but we found it: $rule"
          }
          Write-Output -InputObject "As expected, without GETTEXTCLDRDIR there isn't a Plural-Forms header in the .po file for the locale $lang."

          $env:GETTEXTCLDRDIR = "$PWD\files-unsigned\share\gettext\cldr"
          $po = $pot | & .\files-unsigned\bin\msginit.exe --input=- --output-file=- --locale="$lang"
          $rule = $po -match "Plural-Forms:"
          if ('${{ steps.vars.outputs.cldr-plural-works }}' -eq 'yes') {
            if (-not($rule)) {
              throw "With GETTEXTCLDRDIR there should be a Plural-Forms header in the .po file for the locale $lang, but there isn't."
            }
            Write-Output -InputObject "With GETTEXTCLDRDIR there is a Plural-Forms header ($rule) in the .po file for the locale $lang."
          } else {
            if ($rule) {
              throw "Even with GETTEXTCLDRDIR there shouldn't be a Plural-Forms header in the .po file for the locale $lang, but we found it: $rule"
            }
            Write-Output -InputObject "As expected, even with GETTEXTCLDRDIR there isn't a Plural-Forms header in the .po file for the locale $lang."
          }
      -
        name: Start fake ollama server
        if: steps.vars.outputs.check-spit-exe == 'yes'
        id: start-fake-ollama-server
        shell: pwsh
        run: |
          $process = Start-Process pwsh -ArgumentList '.\build-exe\run-fake-ollama-server.ps1' -WindowStyle Hidden -PassThru
          Start-Sleep -Seconds 2
          $process.Refresh()
          if ($process.HasExited) {
            throw 'Failed to start fake ollama server'
          }
          Write-Host "Started fake ollama server (process ID: $($process.Id))"
          "pid=$($process.Id)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
      -
        name: Check spit executable
        if: needs.versions.outputs.check-spit-exe == 'yes'
        shell: pwsh
        run: |
          $spitPath = '.\files-unsigned\bin\spit.exe'
          if (-not(Test-Path -LiteralPath $spitPath -PathType Leaf)) {
            throw "spit.exe not found at expected path: $spitPath"
          }
          $stdout = Write-Output 'Test' | & $spitPath --model=llama3.2:3b --to=fr
          if (-not($?)) {
            throw "spit.exe failed"
          }
          $stdout = $stdout -join "`n"
          if ($stdout -ne "Ollama answer to prompt Translate into French:`nTest") {
            throw "spit.exe output is unexpected.`nIts output is:`n$stdout"
          }
          Write-Host "spit.exe executed correctly.`nIts output is`n$stdout"
      -
        name: Stop fake ollama server
        if: (success() || failure()) && steps.start-fake-ollama-server.outcome == 'success'
        shell: pwsh
        run: |
          try {
            $process = Get-Process -Id ${{ steps.start-fake-ollama-server.outputs.pid }}
          } catch {
            $process = $null
          }
          if ($null -ne $process) {
            $process.Kill($true)
          }
      -
        name: Upload unsigned files
        if: needs.versions.outputs.signpath-signing-policy
        id: upload-files-unsigned
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.link }}-${{ matrix.bits }}-files-unsigned
          path: files-unsigned
          if-no-files-found: error
          retention-days: 1
      -
        name: Sign files
        if: needs.versions.outputs.signpath-signing-policy
        id: sign-files
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: '${{ secrets.SIGNPATH_API_TOKEN }}'
          organization-id: 98c3accc-92c9-4962-b150-ff1f5c6356b8
          project-slug: gettext-iconv-windows
          signing-policy-slug: '${{ needs.versions.outputs.signpath-signing-policy }}'
          artifact-configuration-slug: ${{ needs.versions.outputs.signpath-artifactconfiguration-files }}
          github-artifact-id: ${{ steps.upload-files-unsigned.outputs.artifact-id }}
          wait-for-completion: true
          output-artifact-directory: files-signed
          parameters: ${{ steps.versioninfos.outputs.signpath-parameters }}
      -
        name: Check signatures
        if: needs.versions.outputs.signpath-signing-policy
        shell: pwsh
        run: >
          ./build-exe/check-signature.ps1
          -Path files-signed
          -CanBeInvalid ${{ needs.versions.outputs.signatures-canbeinvalid == 'yes' && '$true' || '$false'  }}
      -
        name: Create files archive
        shell: pwsh
        run: |
          if ('${{ needs.versions.outputs.signpath-signing-policy }}') {
            Set-Location -LiteralPath 'files-signed'
          } else {
            Set-Location -LiteralPath 'files-unsigned'
          }
          & 7z.exe a -bd -bt -mx9 -r -sse -tzip ..\gettext${{ needs.versions.outputs.gettext-version }}-iconv${{ needs.versions.outputs.iconv-version }}-${{ matrix.link }}-${{ matrix.bits }}.zip
      -
        name: Upload files archive
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.link }}-${{ matrix.bits }}-files
          path: gettext${{ needs.versions.outputs.gettext-version }}-iconv${{ needs.versions.outputs.iconv-version }}-${{ matrix.link }}-${{ matrix.bits }}.zip
          if-no-files-found: error
          compression-level: 0
      -
        name: Prepare installer files
        run: |
          if [ -n '${{ needs.versions.outputs.signpath-signing-policy }}' ]; then
            mv files-signed installer-files
          else
            mv files-unsigned installer-files
          fi
      -
        name: Create installer
        shell: pwsh
        run: >
          ./build-exe/create-installer.ps1
          -Bits ${{ matrix.bits }}
          -Link ${{ matrix.link }}
          -SourceDirectory installer-files
          -OutputDirectory installer-unsigned
          -IconvVersion ${{ needs.versions.outputs.iconv-version }}
          -GettextVersion ${{ needs.versions.outputs.gettext-version }}
      -
        name: Check bitness
        run: ./build-exe/check-bits.sh 32 installer-unsigned/gettext${{ needs.versions.outputs.gettext-version }}-iconv${{ needs.versions.outputs.iconv-version }}-${{ matrix.link }}-${{ matrix.bits }}.exe
      -
        name: Upload unsigned installer
        if: needs.versions.outputs.signpath-signing-policy
        id: upload-installer-unsigned
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.link }}-${{ matrix.bits }}-installer-unsigned
          path: installer-unsigned\gettext${{ needs.versions.outputs.gettext-version }}-iconv${{ needs.versions.outputs.iconv-version }}-${{ matrix.link }}-${{ matrix.bits }}.exe
          if-no-files-found: error
          compression-level: 0
          retention-days: 1
      -
        name: Sign installer
        if: needs.versions.outputs.signpath-signing-policy
        id: sign-installer
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: '${{ secrets.SIGNPATH_API_TOKEN }}'
          organization-id: 98c3accc-92c9-4962-b150-ff1f5c6356b8
          project-slug: gettext-iconv-windows
          signing-policy-slug: '${{ needs.versions.outputs.signpath-signing-policy }}'
          artifact-configuration-slug: gh_sign_installer
          github-artifact-id: ${{ steps.upload-installer-unsigned.outputs.artifact-id }}
          wait-for-completion: true
          output-artifact-directory: installer-signed
      -
        name: Check signature
        if: needs.versions.outputs.signpath-signing-policy
        shell: pwsh
        run: >
          ./build-exe/check-signature.ps1
          -Path installer-signed
          -CanBeInvalid ${{ needs.versions.outputs.signatures-canbeinvalid == 'yes' && '$true' || '$false'  }}
      -
        name: Move installer
        run: |
          if [ -n '${{ needs.versions.outputs.signpath-signing-policy }}' ]; then
            mv installer-signed/*.exe .
          else
            mv installer-unsigned/*.exe .
          fi
      -
        name: Upload installer
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.link }}-${{ matrix.bits }}-installer
          path: gettext${{ needs.versions.outputs.gettext-version }}-iconv${{ needs.versions.outputs.iconv-version }}-${{ matrix.link }}-${{ matrix.bits }}.exe
          if-no-files-found: error
          compression-level: 0
      -
        name: Upload build log
        if: always() && steps.prepare-build-log.outcome == 'success'
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.link }}-${{ matrix.bits }}-log
          if-no-files-found: ignore
          retention-days: 1
          include-hidden-files: true
          compression-level: 0
          path: build-log
      -
        name: Persist cache
        if: always() && steps.restore-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v5
        with:
          key: ${{ steps.restore-cache.outputs.cache-primary-key }}
          path: |
            C:\cygwin-packages
